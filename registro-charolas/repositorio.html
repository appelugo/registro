<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Registro - Retorno de Charolas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; }
        :root {
            --primary: #0A2342; --secondary: #2C4C6B; --accent: #4A89C5;
            --light: #F5F9FF; --white: #FFFFFF; --gray: #E8EEF2; --text-dark: #1E2B3C;
            --success: #27AE60; --danger: #E74C3C; --dominos: #00A5B0; --starbucks: #006241;
            --border-radius: 10px; --box-shadow: 0 4px 12px rgba(10, 35, 66, 0.06);
        }
        body { background-color: var(--gray); color: var(--text-dark); line-height: 1.4; padding: 15px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; background-color: var(--white); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 15px; display: flex; flex-direction: column; height: calc(100vh - 30px); }
        .fixed-header { flex-shrink: 0; background-color: var(--white); padding-bottom: 5px; }
        .header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--accent); }
        .header-left { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .logo-small { max-width: 60px; height: auto; }
        .header h1 { color: var(--primary); font-weight: 600; font-size: 1.5rem; margin: 0; }
        .header h1 span { color: var(--accent); font-weight: 300; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .fecha-fija { background-color: var(--white); padding: 3px 0 5px 0; margin-bottom: 5px; border-bottom: 1px solid var(--gray); font-size: 0.7rem; color: var(--secondary); text-align: right; position: sticky; top: 0; z-index: 15; }
        .stats-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
        .stat-card { background: linear-gradient(135deg, var(--light), var(--white)); padding: 6px 12px; border-radius: 8px; border-left: 4px solid var(--accent); box-shadow: var(--box-shadow); flex: 1 1 160px; }
        .stat-card.dominos { border-left-color: var(--dominos); }
        .stat-card.starbucks { border-left-color: var(--starbucks); }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; color: var(--secondary); font-weight: 600; letter-spacing: 0.5px; }
        .stat-number { font-size: 1.3rem; font-weight: 700; color: var(--primary); line-height: 1.1; }
        .stat-sub { font-size: 0.65rem; color: var(--secondary); margin-top: 2px; }
        .action-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px; }
        .btn { padding: 6px 14px; border: none; border-radius: 6px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.8px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-info { background-color: var(--accent); color: white; }
        .btn-warning { background-color: #F39C12; color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .btn-icono { padding: 6px 10px; font-size: 1rem; }
        .table-section { flex: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; }
        .table-responsive { overflow-x: auto; overflow-y: auto; border-radius: 8px; border: 1px solid var(--gray); max-height: 500px; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        th { background-color: var(--primary); color: white; padding: 8px 8px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        td { padding: 6px 8px; border-bottom: 1px solid var(--gray); font-size: 0.8rem; vertical-align: middle; white-space: nowrap; text-align: center; }
        tr:hover td { background-color: var(--light); }
        td:first-child, td:nth-child(8) { text-align: left; }
        .badge { padding: 2px 8px; border-radius: 50px; font-size: 0.65rem; font-weight: 600; display: inline-block; text-transform: uppercase; white-space: nowrap; }
        .badge-dominos { background-color: rgba(0, 165, 176, 0.1); color: var(--dominos); border: 1px solid var(--dominos); }
        .badge-starbucks { background-color: rgba(0, 98, 65, 0.1); color: var(--starbucks); border: 1px solid var(--starbucks); }
        .badge-turno { background-color: var(--primary); color: white; padding: 2px 6px; border-radius: 20px; font-size: 0.6rem; display: inline-block; white-space: nowrap; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--secondary); }
        .empty-state h3 { font-size: 1.2rem; margin-bottom: 10px; color: var(--primary); }
        .btn-accion { padding: 3px 8px; font-size: 0.6rem; white-space: nowrap; }
        .footer { margin-top: 10px; color: var(--secondary); font-size: 0.65rem; text-align: right; border-top: 1px solid var(--gray); padding-top: 8px; flex-shrink: 0; }
        .password-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .password-container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 350px; text-align: center; max-width: 90%; }
        .password-container h3 { color: var(--primary); margin-bottom: 20px; }
        .password-container input { width: 100%; padding: 12px; border: 2px solid var(--gray); border-radius: 8px; margin-bottom: 20px; font-size: 1rem; }
        .password-container input:focus { border-color: var(--accent); outline: none; }
        .password-actions { display: flex; gap: 10px; justify-content: center; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background-color: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 1100px; max-height: 70vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--accent); }
        .modal-header h2 { color: var(--primary); font-size: 1.3rem; }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: var(--danger); }
        .modal-close:hover { opacity: 0.8; }
        .detalle-info { background-color: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; }
        .detalle-linea1 { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 5px; }
        .detalle-linea2 { color: var(--secondary); font-style: italic; }
        .detalle-table { width: 100%; border-collapse: collapse; }
        .detalle-table th { background-color: var(--secondary); color: white; padding: 8px; font-size: 0.7rem; white-space: nowrap; text-align: center; }
        .detalle-table td { padding: 6px; border-bottom: 1px solid var(--gray); text-align: center; }
        .checkbox-col { width: 30px; text-align: center; }
        .checkbox-all { margin: 0; }
        .loading-spinner { text-align: center; padding: 30px; font-size: 1rem; color: var(--secondary); }
        .loading-spinner::before { content: '‚è≥'; display: block; font-size: 2rem; margin-bottom: 10px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 12px; }
            .header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .header-left { width: 100%; justify-content: center; }
            .header h1 { font-size: 1.3rem; }
            .action-bar { flex-direction: column; align-items: flex-start; }
            .btn-group { width: 100%; }
            .btn { flex: 1; font-size: 0.65rem; }
            td, th { white-space: normal; word-break: break-word; }
            .badge { white-space: normal; }
            .badge-turno { white-space: normal; }
        }
        @media screen and (max-width: 480px) {
            .header h1 { font-size: 1.1rem; }
            .stat-number { font-size: 1.1rem; }
            .btn { font-size: 0.6rem; padding: 5px 8px; }
            .modal-content { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="fixed-header">
            <div class="header">
                <div class="header-left">
                    <img src="logo.png" alt="Logo" style="height: 45px; width: auto;" class="logo-small">
                    <h1>Registro de <span>Charolas</span></h1>
                </div>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="window.location.href='formulario.html'">
                        üìù NUEVO REGISTRO
                    </button>
                    <button class="btn btn-danger btn-icono" onclick="toggleModoEliminacion()" id="btnEliminarHeader" style="padding: 6px 12px;">
                        üóëÔ∏è
                    </button>
                </div>
            </div>

            <div class="fecha-fija" id="fechaActualizacion"></div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-label">Registros HOY</div>
                    <div class="stat-number" id="totalRegistrosHoy">0</div>
                    <div class="stat-sub" id="turnoActualStats">TURNO ACTUAL</div>
                </div>
                <div class="stat-card dominos">
                    <div class="stat-label">DOMINO'S - HOY</div>
                    <div class="stat-number" id="totalDominosHoy">0</div>
                    <div class="stat-sub" id="turnoDominos">TURNO ACTUAL</div>
                </div>
                <div class="stat-card starbucks">
                    <div class="stat-label">STARBUCKS - HOY</div>
                    <div class="stat-number" id="totalStarbucksHoy">0</div>
                    <div class="stat-sub" id="turnoStarbucks">TURNO ACTUAL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tiendas HOY</div>
                    <div class="stat-number" id="totalTiendasHoy">0</div>
                    <div class="stat-sub">Capturadas hoy</div>
                </div>
            </div>

            <div class="action-bar">
                <div class="btn-group" id="botonesEliminarTodo" style="display: none;">
                    <button class="btn btn-warning" onclick="migrarFechas()" style="background-color: #F39C12;">
                        üîÑ MIGRAR FECHAS
                    </button>
                    <button class="btn btn-danger" onclick="eliminarSeleccionados()">
                        üóëÔ∏è ELIMINAR SELECCIONADOS
                    </button>
                    <button class="btn btn-danger" onclick="eliminarTodosRegistros()">
                        üóëÔ∏è ELIMINAR TODOS
                    </button>
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-responsive">
                <table id="tablaRepositorio">
                    <thead>
                        <tr>
                            <th class="checkbox-col" id="headerCheckbox" style="display: none;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
                            </th>
                            <th>Fecha/Hora</th>
                            <th>Turno</th>
                            <th>Empleado</th>
                            <th>Ruta</th>
                            <th>Bit√°cora</th>
                            <th>Unidad</th>
                            <th>Comentarios</th>
                            <th>Tiendas</th>
                            <th>Domino's</th>
                            <th>Starbucks</th>
                            <th>Ver</th>
                            <th id="headerEliminar" style="display: none;">Eliminar</th>
                        </tr>
                    </thead>
                    <tbody id="tablaBody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="footer">
            Sistema de control de Registro de retorno de charolas V2.0 | E.Lugo 2026 Derechos reservados
        </div>
    </div>

    <div id="passwordModal" class="password-modal">
        <div class="password-container">
            <h3>üîê ACCESO RESTRINGIDO</h3>
            <p style="margin-bottom: 15px; color: var(--secondary);">Ingrese contrase√±a de administrador</p>
            <input type="password" id="passwordInput" placeholder="Contrase√±a" onkeypress="if(event.key==='Enter'){verificarPassword();}">
            <div class="password-actions">
                <button class="btn btn-primary" onclick="verificarPassword()">ACCEDER</button>
                <button class="btn btn-danger" onclick="cerrarPasswordModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="detalleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã DETALLE DEL REGISTRO</h2>
                <span class="modal-close" onclick="cerrarDetalleModal()">‚úñ</span>
            </div>
            <div id="detalleContenido"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD0lCq8rAnCm2KjsqSwzxlpUhQU2gRVfk",
            authDomain: "registro-charolas.firebaseapp.com",
            projectId: "registro-charolas",
            storageBucket: "registro-charolas.firebasestorage.app",
            messagingSenderId: "105080206085",
            appId: "1:105080206085:web:443ba22aaf8cbcea767d6c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let modoEliminacionActivo = false;
        const PASSWORD_CORRECTA = 'Hapack90.';
        let seleccionadosAlRecargar = new Set();
        let intervaloCarga = null;

        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }

        function obtenerTurnoActualSimple() {
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const horaDecimal = hora + minutos / 60;
            if (horaDecimal >= 6 && horaDecimal < 14) return 'PRIMERO';
            else if (horaDecimal >= 14 && horaDecimal < 21.5) return 'SEGUNDO';
            else return 'TERCERO';
        }

        function obtenerFechaTurnoActual() {
            const ahora = new Date();
            const hora = ahora.getHours();
            if (hora >= 0 && hora < 6) {
                const ayer = new Date(ahora);
                ayer.setDate(ayer.getDate() - 1);
                return ayer;
            }
            return ahora;
        }

        function extraerTurnoSimple(turnoCompleto) {
            if (!turnoCompleto) return 'S/N';
            if (turnoCompleto.includes('PRIMERO')) return 'PRIMERO';
            if (turnoCompleto.includes('SEGUNDO')) return 'SEGUNDO';
            if (turnoCompleto.includes('TERCERO')) return 'TERCERO';
            return turnoCompleto;
        }

        function esRegistroDelTurnoActual(registro) {
            try {
                const turnoActual = obtenerTurnoActualSimple();
                const fechaTurnoActual = obtenerFechaTurnoActual();
                const turnoRegistro = extraerTurnoSimple(registro.turno);
                
                if (!registro.fechaCaptura) return false;
                
                const fechaParte = registro.fechaCaptura.split(',')[0].trim();
                const partesFecha = fechaParte.split('/');
                if (partesFecha.length !== 3) return false;
                
                const dia = parseInt(partesFecha[0]);
                const mes = parseInt(partesFecha[1]) - 1;
                const anio = parseInt(partesFecha[2]);
                const fechaRegistroObj = new Date(anio, mes, dia);
                
                return (turnoRegistro === turnoActual && fechaRegistroObj.toDateString() === fechaTurnoActual.toDateString());
            } catch (e) { 
                return false; 
            }
        }

        function toggleModoEliminacion() {
            if (modoEliminacionActivo) {
                modoEliminacionActivo = false;
                ocultarBotonesEliminar();
                mostrarToast('üîí Modo eliminaci√≥n desactivado', '#F39C12');
                seleccionadosAlRecargar.clear();
            } else {
                mostrarPasswordModal();
            }
        }

        function mostrarPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }

        function cerrarPasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function verificarPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === PASSWORD_CORRECTA) {
                modoEliminacionActivo = true;
                cerrarPasswordModal();
                mostrarBotonesEliminar();
                mostrarToast('üîê Modo eliminaci√≥n activado', '#27AE60');
            } else {
                alert('‚ùå Contrase√±a incorrecta');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function mostrarToast(mensaje, color) {
            const toast = document.createElement('div');
            toast.textContent = mensaje;
            toast.style.cssText = `position:fixed;top:20px;right:20px;background-color:${color};color:white;padding:10px 18px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:9999;font-size:0.85rem;`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        function mostrarBotonesEliminar() {
            document.getElementById('headerCheckbox').style.display = 'table-cell';
            document.getElementById('headerEliminar').style.display = 'table-cell';
            document.querySelectorAll('[id^="celdaCheckbox_"]').forEach(c => c.style.display = 'table-cell');
            document.querySelectorAll('[id^="celdaEliminar_"]').forEach(c => c.style.display = 'table-cell');
            document.getElementById('botonesEliminarTodo').style.display = 'block';
        }

        function ocultarBotonesEliminar() {
            document.getElementById('headerCheckbox').style.display = 'none';
            document.getElementById('headerEliminar').style.display = 'none';
            document.querySelectorAll('[id^="celdaCheckbox_"]').forEach(c => c.style.display = 'none');
            document.querySelectorAll('[id^="celdaEliminar_"]').forEach(c => c.style.display = 'none');
            document.getElementById('botonesEliminarTodo').style.display = 'none';
        }

        function toggleSelectAll(checked) {
            document.querySelectorAll('[id^="checkRegistro_"]').forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    seleccionadosAlRecargar.add(cb.id.replace('checkRegistro_', ''));
                } else {
                    seleccionadosAlRecargar.delete(cb.id.replace('checkRegistro_', ''));
                }
            });
        }

        function obtenerIdsSeleccionados() {
            const seleccionados = [];
            document.querySelectorAll('[id^="checkRegistro_"]:checked').forEach(cb => {
                seleccionados.push(cb.id.replace('checkRegistro_', ''));
            });
            return seleccionados;
        }

        function guardarSeleccion() {
            seleccionadosAlRecargar.clear();
            document.querySelectorAll('[id^="checkRegistro_"]:checked').forEach(cb => {
                seleccionadosAlRecargar.add(cb.id.replace('checkRegistro_', ''));
            });
        }

        function restaurarSeleccion() {
            if (seleccionadosAlRecargar.size > 0) {
                setTimeout(() => {
                    seleccionadosAlRecargar.forEach(id => {
                        const checkbox = document.getElementById(`checkRegistro_${id}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    
                    const totalCheckboxes = document.querySelectorAll('[id^="checkRegistro_"]').length;
                    const checkboxesSeleccionados = document.querySelectorAll('[id^="checkRegistro_"]:checked').length;
                    const selectAll = document.getElementById('selectAllCheckbox');
                    if (selectAll) {
                        selectAll.checked = totalCheckboxes > 0 && totalCheckboxes === checkboxesSeleccionados;
                    }
                }, 100);
            }
        }

        function actualizarSeleccion(checkbox, id) {
            if (checkbox.checked) {
                seleccionadosAlRecargar.add(id);
            } else {
                seleccionadosAlRecargar.delete(id);
            }
            
            const totalCheckboxes = document.querySelectorAll('[id^="checkRegistro_"]').length;
            const checkboxesSeleccionados = document.querySelectorAll('[id^="checkRegistro_"]:checked').length;
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                selectAll.checked = totalCheckboxes > 0 && totalCheckboxes === checkboxesSeleccionados;
            }
        }

        // ============================================
        // FUNCI√ìN CORREGIDA PARA CONVERTIR FECHA
        // ============================================
        function convertirFechaAFormatoOrdenable(fechaStr) {
            try {
                if (!fechaStr) return '00000000000000';
                
                // Formato: "DD/MM/AAAA, HH:MM:SS" (sin AM/PM)
                const partes = fechaStr.split(',');
                if (partes.length < 2) return '00000000000000';
                
                const fechaParte = partes[0].trim(); // "DD/MM/AAAA"
                const horaParte = partes[1].trim(); // "HH:MM:SS"
                
                // Parsear fecha (DD/MM/AAAA)
                const partesFecha = fechaParte.split('/');
                if (partesFecha.length !== 3) return '00000000000000';
                
                // Reordenar a AAAA/MM/DD para ordenamiento
                const anio = partesFecha[2].padStart(4, '0');
                const mes = partesFecha[1].padStart(2, '0');
                const dia = partesFecha[0].padStart(2, '0');
                
                // Parsear hora (HH:MM:SS)
                const partesHora = horaParte.split(':');
                const horas = partesHora[0]?.padStart(2, '0') || '00';
                const minutos = partesHora[1]?.padStart(2, '0') || '00';
                const segundos = partesHora[2]?.padStart(2, '0') || '00';
                
                // Formato YYYYMMDDHHMMSS (perfecto para ordenar cronol√≥gicamente)
                return anio + mes + dia + horas + minutos + segundos;
                
            } catch (e) {
                console.error('Error convirtiendo fecha:', e);
                return '00000000000000';
            }
        }

        // ============================================
        // MIGRAR FECHAS
        // ============================================
        async function migrarFechas() {
            if (!modoEliminacionActivo) { 
                alert('üîê Debes activar el modo eliminaci√≥n primero'); 
                return; 
            }
            
            if (!confirm('‚ö†Ô∏è ¬øMigrar fechas? Esta acci√≥n actualizar√° TODOS los registros para que se ordenen correctamente.')) return;
            
            try {
                mostrarToast('‚è≥ Migrando fechas...', '#F39C12');
                
                const snapshot = await db.collection('registros').get();
                
                if (snapshot.empty) {
                    alert('No hay registros para migrar.');
                    return;
                }
                
                let migrados = 0;
                let errores = 0;
                
                for (const doc of snapshot.docs) {
                    try {
                        const data = doc.data();
                        const fechaOrden = convertirFechaAFormatoOrdenable(data.fechaCaptura || '');
                        
                        await doc.ref.update({
                            fechaOrden: fechaOrden
                        });
                        migrados++;
                    } catch (error) {
                        console.error('Error migrando documento:', doc.id, error);
                        errores++;
                    }
                }
                
                mostrarToast(`‚úÖ Migraci√≥n completada: ${migrados} actualizados`, '#27AE60');
                cargarDatos();
                
            } catch (error) {
                console.error('Error en migraci√≥n:', error);
                alert('Error en la migraci√≥n: ' + error.message);
            }
        }

        // ============================================
        // CARGAR DATOS
        // ============================================
        async function cargarDatos() {
            if (modoEliminacionActivo) {
                guardarSeleccion();
            }
            
            const tbody = document.getElementById('tablaBody');
            const turnoActual = obtenerTurnoActualSimple();
            
            document.getElementById('fechaActualizacion').innerHTML = `√öltima actualizaci√≥n: ${new Date().toLocaleString()}`;
            document.getElementById('turnoActualStats').textContent = `TURNO: ${turnoActual}`;
            document.getElementById('turnoDominos').textContent = `TURNO: ${turnoActual}`;
            document.getElementById('turnoStarbucks').textContent = `TURNO: ${turnoActual}`;
            
            try {
                const snapshot = await db.collection('registros').get();
                
                if (snapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="13" class="empty-state"><h3>üì≠ No hay registros guardados</h3></td></tr>`;
                    actualizarEstadisticasTurnoActual([]);
                    return;
                }

                const repositorio = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    repositorio.push({ 
                        id: doc.id, 
                        ...data
                    });
                });

                // ORDENAR POR FECHAORDEN (si existe) O CONVERTIR TEMPORALMENTE
                repositorio.sort((a, b) => {
                    // Obtener fechaOrden o calcularla temporalmente
                    const ordenA = a.fechaOrden || convertirFechaAFormatoOrdenable(a.fechaCaptura || '');
                    const ordenB = b.fechaOrden || convertirFechaAFormatoOrdenable(b.fechaCaptura || '');
                    
                    // Orden descendente (m√°s nuevo arriba)
                    if (ordenA > ordenB) return -1;
                    if (ordenA < ordenB) return 1;
                    return 0;
                });

                let html = '';
                repositorio.forEach((registro) => {
                    const turnoSimple = extraerTurnoSimple(registro.turno);
                    const totalDominos = parseInt(registro.resumen?.totalDominos) || 0;
                    const totalStarbucks = parseInt(registro.resumen?.totalStarbucks) || 0;
                    const totalTiendas = parseInt(registro.resumen?.totalTiendas) || 0;
                    const displayCheckbox = modoEliminacionActivo ? 'table-cell' : 'none';
                    const displayEliminar = modoEliminacionActivo ? 'table-cell' : 'none';
                    
                    html += `<tr>
                        <td id="celdaCheckbox_${registro.id}" style="display:${displayCheckbox};" class="checkbox-col">
                            <input type="checkbox" id="checkRegistro_${registro.id}" class="registro-checkbox" onchange="actualizarSeleccion(this, '${registro.id}')">
                        </td>
                        <td><small>${registro.fechaCaptura || 'N/A'}</small></td>
                        <td><span class="badge-turno">${turnoSimple}</span></td>
                        <td>${registro.datosGenerales?.noEmpleado || ''}</td>
                        <td>${registro.datosGenerales?.ruta || ''}</td>
                        <td>${registro.datosGenerales?.bitacora || ''}</td>
                        <td>${registro.datosGenerales?.unidad || ''}</td>
                        <td><small>${(registro.datosGenerales?.comentarios || '').substring(0,30)}${(registro.datosGenerales?.comentarios || '').length > 30 ? '...' : ''}</small></td>
                        <td style="font-weight:600;">${totalTiendas}</td>
                        <td style="color:var(--dominos);font-weight:600;">${totalDominos}</td>
                        <td style="color:var(--starbucks);font-weight:600;">${totalStarbucks}</td>
                        <td><button class="btn btn-info btn-accion" onclick="verDetalle('${registro.id}')">üëÅÔ∏è VER</button></td>
                        <td id="celdaEliminar_${registro.id}" style="display:${displayEliminar};"><button class="btn btn-danger btn-accion" onclick="eliminarRegistro('${registro.id}')">üóëÔ∏è</button></td>
                    </tr>`;
                });

                tbody.innerHTML = html;
                
                if (modoEliminacionActivo) {
                    restaurarSeleccion();
                }
                
                actualizarEstadisticasTurnoActual(repositorio);
                
            } catch (error) {
                console.error('Error al cargar:', error);
                tbody.innerHTML = `<tr><td colspan="13" class="empty-state"><h3>‚ùå Error al conectar</h3><p>${error.message}</p></td></tr>`;
            }
        }

        function actualizarEstadisticasTurnoActual(repositorio) {
            let registrosHoy = 0, totalDominosHoy = 0, totalStarbucksHoy = 0, totalTiendasHoy = 0;
            repositorio.forEach(registro => {
                if (esRegistroDelTurnoActual(registro)) {
                    registrosHoy++;
                    totalDominosHoy += parseInt(registro.resumen?.totalDominos) || 0;
                    totalStarbucksHoy += parseInt(registro.resumen?.totalStarbucks) || 0;
                    totalTiendasHoy += parseInt(registro.resumen?.totalTiendas) || 0;
                }
            });
            document.getElementById('totalRegistrosHoy').textContent = registrosHoy;
            document.getElementById('totalDominosHoy').textContent = Math.round(totalDominosHoy);
            document.getElementById('totalStarbucksHoy').textContent = Math.round(totalStarbucksHoy);
            document.getElementById('totalTiendasHoy').textContent = totalTiendasHoy;
        }

        async function verDetalle(id) {
            document.getElementById('detalleContenido').innerHTML = `<div class="loading-spinner">Cargando detalle...</div>`;
            document.getElementById('detalleModal').style.display = 'flex';

            try {
                const snapshot = await db.collection('registros').where('id', '==', id).limit(1).get();
                const doc = !snapshot.empty ? snapshot.docs[0] : await db.collection('registros').doc(id).get();
                
                if (!doc.exists) {
                    document.getElementById('detalleContenido').innerHTML = `<div style="text-align:center;padding:30px;color:var(--danger);">‚ùå Registro no encontrado</div>`;
                    return;
                }
                
                const registro = doc.data();
                const turnoSimple = extraerTurnoSimple(registro.turno);
                let fechaParte = 'N/A', horaParte = 'N/A';
                if (registro.fechaCaptura) {
                    const partesFecha = registro.fechaCaptura.split(',');
                    fechaParte = partesFecha[0]?.trim() || 'N/A';
                    horaParte = partesFecha[1]?.trim() || 'N/A';
                }

                let html = `<div class="detalle-info"><div class="detalle-linea1">
                    <span><strong>Fecha:</strong> ${fechaParte}</span>
                    <span><strong>Hora:</strong> ${horaParte}</span>
                    <span><strong>Turno:</strong> ${turnoSimple}</span>
                    <span><strong>No. Empleado:</strong> ${registro.datosGenerales?.noEmpleado || ''}</span>
                    <span><strong>Ruta:</strong> ${registro.datosGenerales?.ruta || ''}</span>
                    <span><strong>Bit√°cora:</strong> ${registro.datosGenerales?.bitacora || ''}</span>
                    <span><strong>Unidad:</strong> ${registro.datosGenerales?.unidad || ''}</span>
                </div><div class="detalle-linea2"><strong>Comentarios:</strong> ${registro.datosGenerales?.comentarios || 'S/N'}</div></div>`;
                
                html += `<h3 style="margin-bottom:10px;">üìã TIENDAS CAPTURADAS</h3><table class="detalle-table"><thead><tr><th>TIENDA</th><th>CANTIDAD</th><th>DIFERENCIA</th><th>CNT. F√çSICA</th><th>TIPO</th></tr></thead><tbody>`;
                
                (registro.registros || []).forEach(tienda => {
                    html += `<tr><td>${tienda.tienda || ''}</td><td>${parseFloat(tienda.cantidadBitacora) || 0}</td><td>${parseFloat(tienda.diferencia) || 0}</td><td style="font-weight:600;">${parseFloat(tienda.cantidadFisica) || 0}</td><td><span class="badge ${tienda.tipo === "DOMINO'S" ? 'badge-dominos' : 'badge-starbucks'}">${tienda.tipo || ''}</span></td></tr>`;
                });
                
                html += `</tbody></table><div style="margin-top:15px;padding:10px;background:var(--light);border-radius:8px;"><p><strong>RESUMEN:</strong> Total tiendas: ${registro.resumen?.totalTiendas || 0} | Domino's: ${registro.resumen?.totalDominos || 0} | Starbucks: ${registro.resumen?.totalStarbucks || 0}</p></div>`;
                
                document.getElementById('detalleContenido').innerHTML = html;
            } catch (error) {
                document.getElementById('detalleContenido').innerHTML = `<div style="text-align:center;padding:30px;color:var(--danger);">‚ùå Error: ${error.message}</div>`;
            }
        }

        function cerrarDetalleModal() {
            document.getElementById('detalleModal').style.display = 'none';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarDetalleModal();
                cerrarPasswordModal();
            }
        });

        async function eliminarRegistro(id) {
            if (!modoEliminacionActivo) { alert('üîê Debes activar el modo eliminaci√≥n primero'); return; }
            if (!confirm('¬øEliminar este registro?')) return;
            try {
                const snapshot = await db.collection('registros').where('id', '==', id).limit(1).get();
                if (!snapshot.empty) await snapshot.docs[0].ref.delete();
                else await db.collection('registros').doc(id).delete();
                mostrarToast('üóëÔ∏è Registro eliminado', '#E74C3C');
                cargarDatos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function eliminarSeleccionados() {
            if (!modoEliminacionActivo) { alert('üîê Debes activar el modo eliminaci√≥n primero'); return; }
            const ids = obtenerIdsSeleccionados();
            if (ids.length === 0) { alert('No hay registros seleccionados.'); return; }
            if (!confirm(`¬øEliminar ${ids.length} registro(s)?`)) return;
            try {
                for (const id of ids) {
                    const snapshot = await db.collection('registros').where('id', '==', id).limit(1).get();
                    if (!snapshot.empty) await snapshot.docs[0].ref.delete();
                    else await db.collection('registros').doc(id).delete();
                }
                mostrarToast(`üóëÔ∏è ${ids.length} registro(s) eliminados`, '#E74C3C');
                seleccionadosAlRecargar.clear();
                cargarDatos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function eliminarTodosRegistros() {
            if (!modoEliminacionActivo) { alert('üîê Debes activar el modo eliminaci√≥n primero'); return; }
            if (!confirm('‚ö†Ô∏è ¬øEliminar TODOS los registros?')) return;
            if (!confirm('√öLTIMA CONFIRMACI√ìN:')) return;
            try {
                const snapshot = await db.collection('registros').get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                modoEliminacionActivo = false;
                ocultarBotonesEliminar();
                seleccionadosAlRecargar.clear();
                cargarDatos();
                alert('‚úÖ Todos los registros eliminados');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            ocultarBotonesEliminar();
            if (intervaloCarga) clearInterval(intervaloCarga);
            intervaloCarga = setInterval(cargarDatos, 30000);
        });
    </script>
</body>
</html>
